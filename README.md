# lab-7
# Лаба 7 — Архитектура, слои и DDD-lite (оплата заказа)

В этой лабораторной работе реализована простая система оплаты заказа с разделением на слои (Layered Architecture), применением DIP (зависимость от абстракций) и упрощённым подходом DDD-lite.

## Структура проекта (слои)

- **domain/** — доменная модель и бизнес-правила  
  Содержит сущности, value object и инварианты.
- **application/** — сценарий использования (use-case)  
  Содержит `PayOrderUseCase`, который оркестрирует работу.
- **infrastructure/** — реализации интерфейсов  
  In-memory репозиторий и Fake-платёжный шлюз.
- **tests/** — тесты use-case без БД (pytest)

---

## Доменная модель (Domain)

### Основные элементы
- **Order** — сущность заказа (агрегат)
- **OrderLine** — строка заказа (часть агрегата)
- **Money** — value object (сумма + валюта)
- **OrderStatus** — статус заказа (NEW / PAID)

### Инварианты (бизнес-правила)
1. Нельзя оплатить пустой заказ.
2. Нельзя оплатить заказ повторно.
3. После оплаты нельзя менять строки заказа.
4. Итоговая сумма заказа равна сумме всех строк.

---

## Use-case (Application)

### `PayOrderUseCase` выполняет:
1. Загружает заказ через `OrderRepository.get_by_id(order_id)`.
2. Выполняет доменную операцию оплаты (`order.pay()`), где проверяются инварианты.
3. Вызывает оплату через `PaymentGateway.charge(order_id, money)`.
4. Сохраняет заказ через `OrderRepository.save(order)`.
5. Возвращает результат выполнения (успех/ошибка + сообщение).

---

## Интерфейсы (DIP)

### OrderRepository
- `get_by_id(order_id)`
- `save(order)`

### PaymentGateway
- `charge(order_id, money)`

Use-case зависит только от этих абстракций, а конкретные реализации находятся в слое `infrastructure/`.

---

## Infrastructure

- **InMemoryOrderRepository** — хранит заказы в словаре (без БД).
- **FakePaymentGateway** — имитирует успешную/неуспешную оплату и сохраняет историю вызовов.

---

## Тесты

Проверяется:
- успешная оплата корректного заказа
- ошибка при оплате пустого заказа
- ошибка при повторной оплате
- невозможность изменения заказа после оплаты
- корректный расчёт итоговой суммы

---

